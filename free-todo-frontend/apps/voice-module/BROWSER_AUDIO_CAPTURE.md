# 浏览器中捕获系统音频的替代方案

## ⚠️ 浏览器限制

由于浏览器安全限制，**无法直接捕获系统音频**。浏览器只能：
- ✅ 捕获麦克风（`getUserMedia`）
- ✅ 捕获屏幕/标签页音频（`getDisplayMedia`，需要用户授权）

---

## 🎯 替代方案

### 方案 1：使用 Electron 应用（推荐）⭐

**优点**：
- ✅ 可以直接捕获系统全局音频
- ✅ 无需用户手动选择标签页
- ✅ 捕获所有应用的音频（不只是浏览器）
- ✅ 更好的用户体验

**使用方法**：
```bash
pnpm electron:build-main
pnpm electron:dev
```

**技术实现**：
- 使用 Electron `desktopCapturer` API
- 配合 `getUserMedia` 直接获取系统音频流

---

### 方案 2：虚拟音频设备

**原理**：
将系统音频路由到虚拟音频设备，然后浏览器通过虚拟设备捕获。

**步骤**：

1. **安装虚拟音频设备**
   - Windows: [VB-Audio Virtual Cable](https://vb-audio.com/Cable/)
   - macOS: [BlackHole](https://github.com/ExistentialAudio/BlackHole)
   - Linux: [PulseAudio Virtual Sink](https://wiki.archlinux.org/title/PulseAudio/Examples#Virtual_output_device)

2. **配置系统音频输出**
   - 将系统音频输出设置为虚拟设备
   - 或者使用音频混音器（如 Voicemeeter）同时输出到真实和虚拟设备

3. **浏览器捕获虚拟设备**
   - 浏览器通过 `getUserMedia` 选择虚拟音频设备作为输入
   - 这样就能捕获系统音频了

**优点**：
- ✅ 不需要浏览器扩展
- ✅ 跨浏览器支持
- ✅ 可以同时输出到真实和虚拟设备

**缺点**：
- ❌ 需要用户手动配置
- ❌ 可能影响系统音频输出

---

### 方案 3：浏览器扩展

**原理**：
浏览器扩展可以请求更高权限，可能能够捕获系统音频。

**实现方式**：
1. 开发 Chrome/Edge 扩展
2. 请求 `desktopCapture` 权限
3. 使用 `chrome.desktopCapture` API 获取音频流

**优点**：
- ✅ 可能获得更高权限
- ✅ 用户体验较好（安装后自动工作）

**缺点**：
- ❌ 需要用户安装扩展
- ❌ 不同浏览器需要不同实现
- ❌ 权限可能仍然受限

**示例代码**：
```javascript
// Chrome Extension background.js
chrome.desktopCapture.chooseDesktopMedia(
  ['screen', 'window', 'tab', 'audio'],
  (streamId) => {
    // 使用 streamId 获取音频流
  }
);
```

---

### 方案 4：改进屏幕共享体验（当前方案）

**优化措施**：

1. **更好的提示**
   ```typescript
   // 在用户点击"开始录音"时显示提示
   console.log('💡 提示：');
   console.log('  1. 请在弹出窗口中选择要共享的标签页');
   console.log('  2. 确保勾选"共享选项卡音频"');
   console.log('  3. 建议使用 Electron 应用以获得更好的体验');
   ```

2. **记住用户选择**
   - 使用 localStorage 记住用户上次选择的标签页
   - 下次自动选择（如果可能）

3. **提供清晰的说明**
   - 在 UI 中显示为什么需要选择标签页
   - 提供 Electron 应用的下载链接

**当前实现**：
- ✅ 已优化提示信息
- ✅ 允许用户选择屏幕、窗口或标签页
- ✅ 自动移除视频轨道，只保留音频

---

## 📊 方案对比

| 方案 | 用户体验 | 技术难度 | 跨浏览器 | 推荐度 |
|------|---------|---------|---------|--------|
| **Electron 应用** | ⭐⭐⭐⭐⭐ | 中等 | ✅ | ⭐⭐⭐⭐⭐ |
| **虚拟音频设备** | ⭐⭐⭐ | 低 | ✅ | ⭐⭐⭐⭐ |
| **浏览器扩展** | ⭐⭐⭐⭐ | 高 | ❌ | ⭐⭐⭐ |
| **屏幕共享（当前）** | ⭐⭐ | 低 | ✅ | ⭐⭐ |

---

## 🚀 推荐方案

### 短期（立即可用）
- **继续使用屏幕共享**：改进提示和用户体验
- **提供 Electron 应用**：让用户可以选择更好的体验

### 中期（1-2周）
- **开发浏览器扩展**：提供更好的浏览器体验
- **文档说明虚拟音频设备**：帮助用户配置

### 长期（1-2月）
- **推广 Electron 应用**：作为主要使用方式
- **提供一键安装脚本**：简化虚拟音频设备配置

---

## 💡 当前最佳实践

1. **默认使用屏幕共享**（浏览器环境）
   - 提供清晰的提示
   - 优化用户体验

2. **推荐使用 Electron 应用**（如果可能）
   - 自动检测 Electron 环境
   - 在浏览器中显示提示，引导用户使用 Electron

3. **提供配置指南**
   - 虚拟音频设备配置教程
   - Electron 应用使用说明

---

## 📝 总结

浏览器中捕获系统音频的限制是**浏览器安全策略**，无法绕过。最佳方案是：

1. **优先推荐 Electron 应用**（最佳体验）
2. **浏览器中使用屏幕共享**（当前方案，已优化）
3. **提供虚拟音频设备方案**（高级用户）

当前实现已经优化了屏幕共享体验，并提供了 Electron 应用的自动检测和降级机制。

