# 智能录音助手架构文档

## 📋 目录
1. [系统概述](#系统概述)
2. [整体架构](#整体架构)
3. [核心功能实现](#核心功能实现)
4. [数据流](#数据流)
5. [技术栈](#技术栈)
6. [待完善功能](#待完善功能)

---

## 系统概述

智能录音助手是一个 7×24 小时持续录音、实时语音识别、自动文本优化和日程提取的系统。支持麦克风和系统音频两种输入源，能够实时转录、优化文本、提取日程，并提供基于上下文的智能问答。

### 主要特性
- ✅ **双音频源支持**：麦克风（Web Speech API）和系统音频（Faster-Whisper）
- ✅ **实时转录**：流式语音识别，实时显示转录结果
- ✅ **智能优化**：使用 LLM 优化转录文本，修正语法和标点
- ✅ **日程提取**：自动从文本中提取时间相关的日程信息
- ✅ **音频存储**：分段存储音频文件（每 10 分钟一段）
- ✅ **上下文问答**：基于最近 10 分钟转录内容的智能问答
- ✅ **可视化时间轴**：波形图、日程标记、时间轴导航

---

## 整体架构

### 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     前端 (Next.js + React)                    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           VoiceModulePanel (主控制器)                  │  │
│  │  - 协调所有服务                                        │  │
│  │  - 管理状态 (Zustand)                                 │  │
│  │  - UI 渲染                                            │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                   │
│        ┌─────────────────┼─────────────────┐               │
│        │                 │                 │               │
│  ┌─────▼─────┐   ┌──────▼──────┐  ┌──────▼──────┐        │
│  │ Recording │   │ Recognition │  │ Optimization │        │
│  │  Service  │   │   Service   │  │   Service   │        │
│  └───────────┘   └─────────────┘  └─────────────┘        │
│        │                 │                 │               │
│  ┌─────▼─────┐   ┌──────▼──────┐  ┌──────▼──────┐        │
│  │ Schedule  │   │ Persistence │  │   Chat      │        │
│  │Extraction │   │   Service   │  │  Interface │        │
│  └───────────┘   └─────────────┘  └─────────────┘        │
│                                                               │
└───────────────────────────┬─────────────────────────────────┘
                            │
                    WebSocket / HTTP
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                   后端 (FastAPI + Python)                     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  WebSocket ASR (Faster-Whisper)                       │  │
│  │  - 接收 PCM 音频流                                    │  │
│  │  - 实时语音识别                                       │  │
│  │  - 返回转录结果                                       │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  REST API                                             │  │
│  │  - /api/audio/upload (音频上传)                       │  │
│  │  - /api/transcripts/batch (转录保存)                 │  │
│  │  - /api/schedules (日程保存)                         │  │
│  │  - /api/deepseek/chat/completions (LLM 优化/问答)    │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  存储层                                               │  │
│  │  - 音频文件：本地文件系统 (user_data_dir/audio/)      │  │
│  │  - 转录文本：内存（待集成数据库）                     │  │
│  │  - 日程信息：内存（待集成数据库）                     │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心功能实现

### 1. 音频捕捉 (`RecordingService.ts`)

#### 1.1 麦克风音频捕捉
```typescript
// 使用 getUserMedia API
const stream = await navigator.mediaDevices.getUserMedia({
  audio: {
    echoCancellation: true,
    noiseSuppression: true,
    autoGainControl: true,
  }
});
```

#### 1.2 系统音频捕捉
```typescript
// 使用 getDisplayMedia API（屏幕共享）
const stream = await navigator.mediaDevices.getDisplayMedia({
  audio: {
    echoCancellation: false,
    noiseSuppression: false,
    autoGainControl: false,
  },
  video: { displaySurface: 'browser' }
});
// 移除视频轨道，只保留音频
stream.getVideoTracks().forEach(track => track.stop());
```

#### 1.3 音频分段存储
- **分段策略**：每 10 分钟自动分段
- **格式**：WebM（浏览器原生支持）
- **存储位置**：前端内存 → 后端文件系统
- **文件命名**：`{segmentId}_{timestamp}.webm`

#### 1.4 实时波形显示
- 使用 `AudioContext` + `AnalyserNode` 获取音频数据
- 通过 `getByteTimeDomainData()` 获取时域数据
- Canvas 实时绘制波形图

---

### 2. 语音识别

#### 2.1 麦克风模式：Web Speech API
```typescript
// 浏览器原生 API，免费、快速
const recognition = new webkitSpeechRecognition();
recognition.lang = 'zh-CN';
recognition.continuous = true;
recognition.interimResults = true; // 实时临时结果
```

**特点**：
- ✅ 免费、无需后端
- ✅ 延迟低（< 1 秒）
- ✅ 支持临时结果（interim results）
- ❌ 仅支持麦克风输入
- ❌ 准确率一般

#### 2.2 系统音频模式：Faster-Whisper (WebSocket)
```typescript
// 前端：发送原始 PCM 数据
const audioContext = new AudioContext({ sampleRate: 16000 });
const scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
scriptProcessor.onaudioprocess = (e) => {
  const int16 = new Int16Array(inputData.length);
  // 转换为 Int16 PCM
  ws.send(int16.buffer);
};
```

**后端处理流程**：
1. 接收 PCM Int16 数据
2. 缓冲到 `deque`（最多 6 秒）
3. 每 3 秒处理一次（32000 样本）
4. 转换为 float32 numpy 数组
5. 调用 Faster-Whisper 识别
6. 繁简转换
7. 返回 JSON 结果

**Faster-Whisper 参数**：
```python
model.transcribe(
    audio_array,
    beam_size=5,  # 提高准确率
    language="zh",
    vad_filter=True,  # 语音活动检测
    condition_on_previous_text=True,  # 依赖前文
    best_of=5,
    temperature=(0.0, 0.2, 0.4, 0.6, 0.8),
    compression_ratio_threshold=2.4,
    logprob_threshold=-1.0,
    no_speech_threshold=0.6,
)
```

**特点**：
- ✅ 支持系统音频
- ✅ 准确率高
- ✅ 开源免费
- ❌ 需要后端服务
- ❌ 延迟较高（2-3 秒）
- ❌ 需要下载模型（约 1.5GB）

---

### 3. 文本优化 (`OptimizationService.ts`)

#### 3.1 优化流程
1. **队列管理**：批量处理（每批 3 条）
2. **LLM 调用**：DeepSeek API（OpenAI 兼容）
3. **系统提示词**：
   - 修正语法和标点
   - 保留所有原始信息
   - 标记日程信息：`[SCHEDULE: ...]`

#### 3.2 优化示例
```
输入：早上7点准时起床,洗术完毕后
输出：[SCHEDULE: 早上7点准时起床],洗漱完毕后
```

---

### 4. 日程提取 (`ScheduleExtractionService.ts`)

#### 4.1 提取策略
1. **LLM 标记提取**：从 `[SCHEDULE: ...]` 标签中提取
2. **正则模式匹配**：直接匹配时间模式
   - `早上7点`、`7:40`、`明天下午3点`
   - `11:30`、`8点至10`

#### 4.2 时间解析
```typescript
// 支持多种时间格式
- 相对时间：今天、明天、后天
- 时间段：早上、上午、中午、下午、晚上
- 绝对时间：7:40、11:30
- 日期：12月22日 17:30
```

#### 4.3 智能推断
- 如果时间已过，自动推断为明天
- 如果只有时间没有日期，使用当前日期

---

### 5. 数据存储 (`PersistenceService.ts`)

#### 5.1 音频存储
- **前端**：`MediaRecorder` 生成 WebM Blob
- **上传**：`POST /api/audio/upload`（FormData）
- **后端存储**：`user_data_dir/audio/{segmentId}_{timestamp}.webm`
- **文件大小**：约 1-5 MB/10 分钟（取决于音频质量）

#### 5.2 转录文本存储
- **当前实现**：内存存储（`_transcripts_db`）
- **API**：`POST /api/transcripts/batch`
- **待完善**：集成数据库（SQLite/PostgreSQL）

#### 5.3 日程存储
- **当前实现**：内存存储（`_schedules_db`）
- **API**：`POST /api/schedules`
- **待完善**：集成数据库

#### 5.4 批量上传策略
- **队列机制**：失败自动重试
- **批量大小**：转录文本 10 条/批，日程 5 条/批
- **延迟上传**：2 秒延迟，减少请求频率

---

### 6. 上下文问答 (`ChatInterface.tsx`)

#### 6.1 问答流程
1. 用户提问
2. 收集最近 10 分钟的转录内容
3. 构建上下文提示词
4. 调用 DeepSeek API（流式响应）
5. 实时渲染 Markdown 结果

#### 6.2 系统提示词
```
你是一个智能语音助手。请根据提供的最近10分钟的语音转录上下文回答用户问题。
如果答案不在上下文中，请明确告知。
```

#### 6.3 流式响应
- **后端**：Server-Sent Events (SSE)
- **前端**：`fetch` + `TextDecoder` 逐块解析
- **渲染**：`react-markdown` + `remark-gfm`

---

## 数据流

### 完整数据流图

```
┌─────────────┐
│  用户开始录音 │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────┐
│  RecordingService.start()           │
│  - 获取 MediaStream                 │
│  - 创建 MediaRecorder               │
│  - 开始录制（10分钟分段）           │
└──────┬──────────────────────────────┘
       │
       ├──────────────────────────────┐
       │                              │
       ▼                              ▼
┌─────────────────┐        ┌──────────────────────┐
│  Web Speech API  │        │  WebSocket ASR       │
│  (麦克风模式)     │        │  (系统音频模式)      │
└──────┬───────────┘        └──────┬───────────────┘
       │                            │
       │ 实时识别结果                │ PCM 音频流
       │                            │
       ▼                            ▼
┌──────────────────────────────────────────┐
│  handleRecognitionResult()              │
│  - 创建/更新转录片段                     │
│  - 显示临时结果（灰色斜体）              │
│  - 最终结果（正常显示）                  │
└──────┬───────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────┐
│  OptimizationService.enqueue()           │
│  - 加入优化队列                          │
│  - 批量调用 LLM 优化                    │
│  - 标记日程信息                         │
└──────┬───────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────┐
│  ScheduleExtractionService.enqueue()      │
│  - 解析 [SCHEDULE: ...] 标签             │
│  - 正则匹配时间模式                      │
│  - 创建日程项                            │
└──────┬───────────────────────────────────┘
       │
       ├──────────────────────────────┐
       │                              │
       ▼                              ▼
┌─────────────────┐        ┌──────────────────────┐
│  Persistence    │        │  UI 更新             │
│  Service        │        │  - 转录列表           │
│  - 上传音频     │        │  - 日程列表           │
│  - 保存转录     │        │  - 时间轴标记         │
│  - 保存日程     │        │                       │
└─────────────────┘        └──────────────────────┘
```

---

## 技术栈

### 前端
- **框架**：Next.js 14 + React 18
- **状态管理**：Zustand
- **UI 组件**：Tailwind CSS
- **音频处理**：
  - `MediaRecorder API`（录音）
  - `AudioContext` + `AnalyserNode`（波形）
  - `ScriptProcessorNode`（PCM 转换）
- **WebSocket**：原生 WebSocket API
- **Markdown 渲染**：`react-markdown` + `remark-gfm`
- **时间处理**：`date-fns` + `zhCN` locale

### 后端
- **框架**：FastAPI
- **WebSocket**：FastAPI WebSocket
- **ASR**：Faster-Whisper
- **LLM**：DeepSeek API（OpenAI 兼容）
- **音频处理**：`numpy`（PCM 转换）
- **繁简转换**：`opencc-python-reimplemented`
- **存储**：本地文件系统（音频文件）

---

## 待完善功能

### 🔴 高优先级

#### 1. 数据库集成
- **当前状态**：转录文本和日程仅存储在内存中
- **待实现**：
  - 集成 SQLite/PostgreSQL
  - 持久化转录文本、日程、音频元数据
  - 支持历史查询和搜索

#### 2. 音频压缩和优化
- **当前状态**：WebM 格式，文件较大
- **待实现**：
  - 音频压缩（Opus 编码）
  - 自动清理过期音频（保留策略）
  - 音频索引和快速检索

#### 3. 识别准确率提升
- **当前问题**：音乐识别准确率低
- **待实现**：
  - VAD（语音活动检测）优化
  - 说话人分离（多人对话）
  - 自定义词汇表（专业术语）

#### 4. 错误处理和重试机制
- **当前状态**：基础重试机制
- **待实现**：
  - 指数退避重试
  - 离线队列（IndexedDB）
  - 错误恢复和状态同步

### 🟡 中优先级

#### 5. 多语言支持
- **当前状态**：仅支持中文
- **待实现**：
  - 自动语言检测
  - 多语言识别（中英混合）
  - 多语言界面

#### 6. 实时转录优化
- **当前问题**：延迟较高（2-3 秒）
- **待实现**：
  - 流式 VAD（更快的响应）
  - 增量识别（减少延迟）
  - 本地模型（完全离线）

#### 7. 日程管理增强
- **当前状态**：基础日程提取
- **待实现**：
  - 日程冲突检测
  - 日程提醒（通知）
  - 日程编辑和删除
  - 日程同步（日历应用）

#### 8. 搜索和检索
- **当前状态**：无搜索功能
- **待实现**：
  - 全文搜索（转录文本）
  - 时间范围搜索
  - 关键词高亮
  - 语音搜索

### 🟢 低优先级

#### 9. 用户界面优化
- **待实现**：
  - 暗色模式
  - 响应式设计（移动端）
  - 自定义主题
  - 快捷键支持

#### 10. 分析和统计
- **待实现**：
  - 录音时长统计
  - 识别准确率统计
  - 日程提取准确率
  - 使用情况分析

#### 11. 导出功能
- **待实现**：
  - 导出转录文本（TXT/Markdown）
  - 导出音频文件
  - 导出日程（iCal/CSV）
  - 批量导出

#### 12. 协作功能
- **待实现**：
  - 多用户支持
  - 共享录音和转录
  - 团队日程管理
  - 权限控制

---

## 性能优化建议

### 前端优化
1. **音频处理**：使用 Web Worker 处理 PCM 转换
2. **状态管理**：优化 Zustand store，减少不必要的重渲染
3. **Canvas 渲染**：使用 `requestAnimationFrame` 优化波形绘制
4. **内存管理**：定期清理旧的转录片段和音频 Blob

### 后端优化
1. **模型加载**：延迟加载 Faster-Whisper 模型
2. **并发处理**：使用线程池处理多个识别任务
3. **缓存机制**：缓存常用转录结果
4. **数据库索引**：为时间字段创建索引

---

## 总结

智能录音助手已经实现了核心功能：
- ✅ 双音频源支持
- ✅ 实时语音识别
- ✅ 文本优化和日程提取
- ✅ 音频存储
- ✅ 上下文问答

**下一步重点**：
1. 数据库集成（持久化存储）
2. 识别准确率提升（特别是音乐识别）
3. 错误处理和离线支持
4. 搜索和检索功能

---

**文档版本**：v1.0  
**最后更新**：2025-12-21  
**维护者**：LifeTrace Team From zy
