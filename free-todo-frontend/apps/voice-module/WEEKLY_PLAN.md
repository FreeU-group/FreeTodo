# 一周内完成计划（核心功能）

## 🎯 目标
一周内完成音频模块的核心功能，确保基本可用。

---

## ✅ 已完成（今天）

1. **修复保存逻辑**：
   - ✅ 识别结果创建后，立即保存原始转录文本
   - ✅ 优化完成后，立即保存优化后的文本
   - ✅ 停止录音时，保存所有未保存的转录文本

2. **优化系统音频捕获**：
   - ✅ 添加 Electron desktopCapturer API 支持（准备）
   - ✅ 改进用户体验提示
   - ⚠️ 注意：浏览器安全限制，仍需要用户授权，但可以提供更好的体验

3. **降低识别延迟**：
   - ✅ 后端：处理间隔 2秒 → 0.8秒
   - ✅ 前端：更新 chunkDuration 为 0.8秒

---

## 🚀 本周计划（剩余任务）

### Day 1-2：修复回放一致性和数据流（优先级最高）

#### 1. 修复回放一致性
**目标**：确保回放的音频就是识别用的音频

**实施步骤**：
1. **后端**：识别服务返回精确的时间范围
   ```python
   # voice_stream_whisper.py
   await websocket.send_json({
       "text": result,
       "isFinal": True,
       "startTime": relative_start_time,  # 秒（精确到毫秒）
       "endTime": relative_end_time,        # 秒（精确到毫秒）
   })
   ```

2. **前端**：使用相同的时间范围提取音频
   ```typescript
   // VoiceModulePanel.tsx
   const audioBlob = await recordingService.extractAudioSegment(
     startTime * 1000,  // 使用识别服务记录的时间
     endTime * 1000     // 使用识别服务记录的时间
   );
   ```

3. **验证**：提取后验证时长是否匹配

#### 2. 简化数据流
**目标**：统一音频源，避免数据不同步

**实施步骤**：
1. **统一音频源**：识别和存储都使用同一个 MediaStream
2. **优化存储逻辑**：识别结果 → 立即提取音频片段 → 存储
3. **异步处理**：不阻塞识别显示

---

### Day 3-4：优化用户体验

#### 1. 改进系统音频捕获体验
**目标**：提供更好的用户体验

**实施步骤**：
1. **添加 UI 提示**：
   - 显示"正在请求系统音频权限..."
   - 提示用户选择包含音频的标签页
   - 显示当前选择的音频源

2. **错误处理优化**：
   - 友好的错误提示
   - 自动重试机制
   - 降级方案（如果系统音频不可用，提示使用麦克风）

#### 2. 优化识别结果显示
**目标**：实时显示识别结果，体验流畅

**实施步骤**：
1. **临时结果**：实时显示（灰色闪烁）
2. **最终结果**：立即显示（正常）
3. **优化结果**：后台异步优化，完成后更新

---

### Day 5-7：测试和优化

#### 1. 功能测试
- ✅ 测试识别延迟（目标：< 1秒）
- ✅ 测试回放一致性（确保回放的音频就是识别用的音频）
- ✅ 测试保存功能（原始和优化后的文本都能保存）
- ✅ 测试系统音频捕获（用户体验）

#### 2. 性能优化
- ✅ 优化音频处理性能
- ✅ 优化内存使用
- ✅ 优化网络请求

#### 3. Bug 修复
- ✅ 修复发现的问题
- ✅ 优化错误处理
- ✅ 改进日志记录

---

## 📋 技术细节

### 1. 系统音频捕获改进

**当前问题**：
- 需要用户手动选择标签页
- 用户体验不够好

**改进方案**：
1. **Electron 环境**：
   - 使用 `desktopCapturer` API 获取可用音频源列表
   - 自动选择第一个可用源（如果可能）
   - 提供源选择 UI（如果需要）

2. **浏览器环境**：
   - 改进提示信息
   - 提供更好的错误处理
   - 降级方案

**注意**：
- 浏览器安全限制，无法完全自动化
- 但可以提供更好的用户体验（提示、错误处理等）

### 2. 识别延迟优化

**当前状态**：
- ✅ 后端：处理间隔 0.8秒
- ✅ 前端：chunkDuration 0.8秒
- ⏳ 实际测试延迟

**优化方向**：
1. **进一步降低延迟**（如果可能）：
   - 处理间隔 0.8秒 → 0.5秒（需要测试）
   - 最小样本数 8000 → 4000（需要测试）

2. **优化处理性能**：
   - 使用更快的识别模型（如果可用）
   - 优化音频处理流程

### 3. 回放一致性保证

**实施步骤**：
1. **时间戳对齐**：
   - 识别服务记录精确的时间范围
   - 存储时使用相同的时间范围

2. **验证机制**：
   - 提取后验证时长
   - 如果差异 > 100ms，记录警告

3. **关联存储**：
   - 音频文件关联识别结果ID
   - 回放时优先使用关联的音频文件

---

## ⚠️ 注意事项

1. **浏览器安全限制**：
   - 系统音频捕获需要用户授权
   - 无法完全自动化
   - 但可以提供更好的用户体验

2. **性能平衡**：
   - 延迟 vs 准确率
   - 实时性 vs 资源消耗

3. **向后兼容**：
   - 确保新功能不影响现有功能
   - 提供降级方案

---

## 🎯 成功标准

### 核心功能（必须完成）
- ✅ 原始和优化后的文本都能保存
- ⏳ 回放的音频就是识别用的音频（时间戳对齐）
- ⏳ 识别延迟 < 1秒
- ⏳ 系统音频捕获用户体验改进

### 优化功能（尽量完成）
- ⏳ 数据流简化
- ⏳ 错误处理优化
- ⏳ 性能优化

---

## 📝 每日进度跟踪

### Day 1（今天）
- ✅ 修复保存逻辑
- ✅ 优化系统音频捕获（准备）
- ✅ 降低识别延迟（后端和前端）

### Day 2-3
- ⏳ 修复回放一致性
- ⏳ 简化数据流

### Day 4-5
- ⏳ 优化用户体验
- ⏳ 改进系统音频捕获体验

### Day 6-7
- ⏳ 测试和优化
- ⏳ Bug 修复

